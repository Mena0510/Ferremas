{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Catálogo de Productos</h2>

  <!-- Filtro -->
  <form method="get" class="row g-2 align-items-end mb-4">
    <div class="col-md-5">
      <label class="form-label">Buscar por nombre</label>
      <input type="text" name="nombre" value="{{ nombre_actual }}" class="form-control" placeholder="Ej: martillo">
    </div>
    <div class="col-md-5">
      <label class="form-label">Filtrar por categoría</label>
      <select name="categoria" class="form-select">
        <option {% if categoria_actual == 'Todas' %}selected{% endif %}>Todas</option>
        {% for cat in categorias %}
        <option value="{{ cat }}" {% if cat == categoria_actual %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
  </form>

  <!-- Enlace para crear nuevo producto (solo staff) -->
  {% if user.is_authenticated and user.is_staff %}
  <div class="mb-3 text-end">
    <a href="{% url 'crear_producto' %}" class="btn btn-success">
      <i class="bi bi-plus-circle"></i> Nuevo Producto
    </a>
  </div>
  {% endif %}

  <!-- Productos -->
  <div class="row">
    {% for producto in page_obj %}
    <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
      <div class="card h-100 shadow-sm rounded-4">
        <!-- Imagen -->
        {% if producto.imagen %}
        <img src="{{ producto.imagen.url }}" class="card-img-top fixed-img rounded-top-4" alt="{{ producto.nombre }}">
        {% else %}
        <img src="https://via.placeholder.com/300x200?text=Sin+Imagen" class="card-img-top fixed-img rounded-top-4" alt="Sin imagen">
        {% endif %}

        <!-- Cuerpo de la tarjeta -->
        <div class="card-body d-flex flex-column">
          <h5 class="card-title text-truncate">{{ producto.nombre }}</h5>
          <p class="card-text">{{ producto.descripcion|truncatechars:80 }}</p>
          <p class="fw-bold fs-5 text-success mb-1">${{ producto.precio }}</p>
          <p class="text-muted small">Stock: {{ producto.stock }}</p>

          <!-- Botón agregar al carrito -->
          <form method="post" action="{% url 'agregar_al_carrito' producto.id %}" class="mt-auto">
            {% csrf_token %}
            {% if producto.stock > 0 %}
              <button type="submit" class="btn btn-primary w-100 mt-2">
                Agregar al carrito
              </button>
            {% else %}
              <button type="button" class="btn btn-secondary w-100 mt-2" disabled>
                Sin stock disponible
              </button>
            {% endif %}
          </form>

          <!-- Enlaces de edición/eliminación (solo staff) -->
          {% if user.is_authenticated and user.is_staff %}
          <div class="d-flex justify-content-center mt-3">
            <a href="{% url 'editar_producto' producto.id %}" class="btn btn-sm btn-warning me-2">
              <i class="bi bi-pencil-square"></i>
            </a>
            <a href="{% url 'eliminar_producto' producto.id %}" class="btn btn-sm btn-danger">
              <i class="bi bi-trash"></i>
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Paginación -->
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{% if nombre_actual %}nombre={{ nombre_actual }}&{% endif %}{% if categoria_actual %}categoria={{ categoria_actual }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
      </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      </li>

      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?{% if nombre_actual %}nombre={{ nombre_actual }}&{% endif %}{% if categoria_actual %}categoria={{ categoria_actual }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>

<!-- Estilos -->
<style>
  .fixed-img {
    height: 200px;
    object-fit: cover;
  }

  .card-title {
    font-weight: 600;
    font-size: 1.2rem;
    margin-bottom: 0.4rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .card-text {
    font-size: 0.95rem;
    color: #555;
  }
</style>
{% endblock %}
